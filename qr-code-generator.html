<!
        padding: 8px 15px;
        border: none;
        background: #e9ecef;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
        border-bottom: 2px solid transparent;
        font-weight: 600;
    }
    .tab-button.active {
        background: var(--primary-color);
        color: white;
        border-bottom: 2px solid var(--success-color);
    }
    .tab-button:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
    .tab-button:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }

    /* Input Fields */
    .input-fields {
        border: 1px solid var(--border-color);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: left;
    }

    .input-fields input[type="text"], 
    .input-fields textarea {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        margin-top: 5px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        box-sizing: border-box;
    }
    .input-fields label {
        display: block;
        font-weight: 500;
        margin-top: 10px;
    }

    /* Options Section */
    .options-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 20px;
      text-align: left;
    }

    .option-group {
      display: flex;
      flex-direction: column;
    }

    .option-group label {
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 13px;
    }
    
    .option-group input[type="number"], 
    .option-group input[type="color"],
    .option-group select {
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        width: 100%;
    }
    
    .option-group input[type="color"] {
        height: 38px;
    }

    /* QR Display and Buttons */
    #qrcode-canvas-container {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      min-height: 250px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      background-color: white;
      overflow: hidden;
    }
    
    #logo-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: 20%;
        max-height: 20%;
        z-index: 10;
        pointer-events: none;
    }

    .button-group {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 25px;
    }

    button {
      padding: 10px 18px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: var(--primary-hover);
    }

    #downloadBtn {
      background-color: var(--success-color);
      display: none;
    }

    #downloadBtn:hover {
      background-color: var(--success-hover);
    }
    
    #message {
        margin-top: 15px;
        min-height: 20px;
        color: var(--text-color);
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Master QR Studio üñºÔ∏è</h2>
    
    <div class="tab-container">
        <button class="tab-button active" onclick="changeDataType('TEXT')">Text/URL</button>
        <button class="tab-button" onclick="changeDataType('WIFI')">Wi-Fi</button>
        <button class="tab-button" onclick="changeDataType('VCARD')">Contact (vCard)</button>
    </div>

    <div class="input-fields" id="dynamicInputFields">
        <label for="urlText">Content:</label>
        <textarea id="qrText" placeholder="Enter URL, email, or simple text." oninput="debouncedGenerateQR()"></textarea>
    </div>

    <div class="options-grid">
        <div class="option-group">
            <label for="qrSize">Size (px):</label>
            <input type="number" id="qrSize" value="300" min="100" max="1024" onchange="debouncedGenerateQR()">
        </div>
        <div class="option-group">
            <label for="qrDarkColor">Foreground Color:</label>
            <input type="color" id="qrDarkColor" value="#5d50c6" onchange="debouncedGenerateQR()">
        </div>
        <div class="option-group">
            <label for="qrLightColor">Background Color:</label>
            <input type="color" id="qrLightColor" value="#ffffff" onchange="debouncedGenerateQR()">
        </div>
        <div class="option-group">
            <label for="qrQuietZone">Quiet Zone (px):</label>
            <input type="number" id="qrQuietZone" value="10" min="0" max="50" onchange="debouncedGenerateQR()">
        </div>
        <div class="option-group">
            <label for="qrCorrection">Error Correction:</label>
            <select id="qrCorrection" onchange="debouncedGenerateQR()">
                <option value="L">Low</option>
                <option value="M">Medium</option>
                <option value="Q">Quartile</option>
                <option value="H" selected>High</option>
            </select>
        </div>
        <div class="option-group">
            <label for="downloadFormat">Download Format:</label>
            <select id="downloadFormat" onchange="debouncedGenerateQR()">
                <option value="png">PNG</option>
                <option value="jpeg">JPEG</option>
                <option value="svg">SVG</option>
            </select>
        </div>
        <div class="option-group" style="grid-column: span 2;">
            <label for="logoImage">Embed Logo (PNG/JPG):</label>
            <input type="file" id="logoImage" accept="image/png, image/jpeg" onchange="loadLogo()">
        </div>
    </div>
    
    <div id="message"></div>

    <div id="qrcode-canvas-container">
        <img id="logo-overlay" src="" alt="Embedded Logo" style="display:none;">
    </div>
    
    <div class="button-group">
        <button id="downloadBtn" onclick="downloadQR()">‚¨áÔ∏è Download Code</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <script>
    let qr;
    let debounceTimer;
    let currentDataType = 'TEXT';
    let logoDataURL = null; // Stores the loaded logo image data

    // --- Utility Functions ---

    function showMessage(text, type = 'info') {
        const msgElement = document.getElementById("message");
        msgElement.textContent = text;
        msgElement.style.color = type === 'error' ? 'red' : (type === 'success' ? 'green' : var(--text-color));
        setTimeout(() => { msgElement.textContent = ''; }, 4000);
    }

    function debouncedGenerateQR() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(generateQR, 300);
    }

    // --- Data Serialization Logic ---

    function getFormattedQRData() {
        let data = '';
        const fields = document.getElementById('dynamicInputFields');
        
        switch (currentDataType) {
            case 'WIFI':
                const ssid = fields.querySelector('#wifiSSID').value || '';
                const password = fields.querySelector('#wifiPassword').value || '';
                const encryption = fields.querySelector('#wifiEncryption').value || 'WPA';
                // Standard WiFi format: WIFI:T:WPA;S:MyNetwork;P:MyPassword;;
                data = `WIFI:T:${encryption};S:${ssid};P:${password};;`;
                break;
            case 'VCARD':
                const name = fields.querySelector('#vcardName').value || '';
                const phone = fields.querySelector('#vcardPhone').value || '';
                const email = fields.querySelector('#vcardEmail').value || '';
                // Standard vCard format (simplified)
                data = `BEGIN:VCARD\nVERSION:3.0\nN:${name}\nFN:${name}\nTEL:${phone}\nEMAIL:${email}\nEND:VCARD`;
                break;
            case 'TEXT':
            default:
                data = fields.querySelector('#qrText').value.trim();
                break;
        }
        return data;
    }

    // --- Dynamic UI Logic ---

    function changeDataType(type) {
        currentDataType = type;
        const container = document.getElementById('dynamicInputFields');
        const tabs = document.querySelectorAll('.tab-button');
        let newFieldsHTML = '';

        tabs.forEach(tab => tab.classList.remove('active'));
        document.querySelector(`.tab-button[onclick*='${type}']`).classList.add('active');

        switch (type) {
            case 'WIFI':
                newFieldsHTML = `
                    <label for="wifiSSID">SSID/Network Name:</label>
                    <input type="text" id="wifiSSID" placeholder="OfficeGuestWifi" oninput="debouncedGenerateQR()">
                    <label for="wifiPassword">Password:</label>
                    <input type="text" id="wifiPassword" placeholder="password123" oninput="debouncedGenerateQR()">
                    <label for="wifiEncryption">Encryption:</label>
                    <select id="wifiEncryption" onchange="debouncedGenerateQR()">
                        <option value="WPA">WPA/WPA2</option>
                        <option value="WEP">WEP</option>
                        <option value="nopass">None</option>
                    </select>
                `;
                break;
            case 'VCARD':
                newFieldsHTML = `
                    <label for="vcardName">Full Name:</label>
                    <input type="text" id="vcardName" placeholder="John Doe" oninput="debouncedGenerateQR()">
                    <label for="vcardPhone">Phone Number:</label>
                    <input type="text" id="vcardPhone" placeholder="+1234567890" oninput="debouncedGenerateQR()">
                    <label for="vcardEmail">Email:</label>
                    <input type="text" id="vcardEmail" placeholder="john.doe@example.com" oninput="debouncedGenerateQR()">
                `;
                break;
            case 'TEXT':
            default:
                newFieldsHTML = `
                    <label for="qrText">Content (URL, Text, Email, etc.):</label>
                    <textarea id="qrText" placeholder="https://www.google.com" oninput="debouncedGenerateQR()"></textarea>
                `;
                break;
        }
        container.innerHTML = newFieldsHTML;
        debouncedGenerateQR();
    }

    // --- Logo Image Handling ---

    function loadLogo() {
        const fileInput = document.getElementById('logoImage');
        const file = fileInput.files[0];
        const logoImgElement = document.getElementById('logo-overlay');
        
        if (!file) {
            logoDataURL = null;
            logoImgElement.style.display = 'none';
            return;
        }

        if (file.size > 1024 * 1024 * 2) { // 2MB limit
            showMessage('‚ùå Logo file is too large (max 2MB).', 'error');
            fileInput.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            logoDataURL = e.target.result;
            logoImgElement.src = logoDataURL;
            logoImgElement.style.display = 'block';
            showMessage('‚úÖ Logo loaded. Generating code with embedded image.', 'success');
            debouncedGenerateQR(); // Regenerate with logo
        };
        reader.readAsDataURL(file);
    }
    
    // --- QR Generation and Drawing ---

    function generateQR() {
      const data = getFormattedQRData();
      const qrContainer = document.getElementById("qrcode-canvas-container");
      const downloadBtn = document.getElementById("downloadBtn");
      const size = parseInt(document.getElementById("qrSize").value) || 300;
      const correction = document.getElementById("qrCorrection").value;
      const darkColor = document.getElementById("qrDarkColor").value;
      const lightColor = document.getElementById("qrLightColor").value;
      const quietZone = parseInt(document.getElementById("qrQuietZone").value) || 10;
      
      qrContainer.innerHTML = `<img id="logo-overlay" src="${logoDataURL || ''}" alt="Embedded Logo" style="display:${logoDataURL ? 'block' : 'none'};">`;
      downloadBtn.style.display = "none";
      document.getElementById("message").textContent = "";

      if (data === "") {
        document.getElementById("message").textContent = "‚ö†Ô∏è Data field is empty.";
        return;
      }

      try {
          // Initialize qrious with parameters
          qr = new QRious({
            element: document.createElement('canvas'), // Create temporary canvas
            value: data,
            size: size,
            level: correction,
            foreground: darkColor,
            background: lightColor,
            padding: quietZone, // Quiet Zone
            // Note: qrious outputs to a canvas element, not SVG directly
          });

          const canvas = qr.element;
          canvas.style.display = 'block'; // Make sure the canvas is visible
          qrContainer.appendChild(canvas); // Append canvas to the container

          // Set canvas dimensions to ensure proper scaling
          canvas.width = size;
          canvas.height = size;

          // Re-insert the logo element to be on top of the new canvas
          const logoOverlay = document.getElementById('logo-overlay');
          qrContainer.appendChild(logoOverlay);
          
          // Show the download button
          setTimeout(() => {
            downloadBtn.style.display = "inline-block";
          }, 100); 

      } catch (e) {
          showMessage("‚ùå An error occurred during QR code generation.", 'error');
          console.error(e);
      }
    }

    // --- Download Logic ---

    function downloadQR() {
        const downloadFormat = document.getElementById("downloadFormat").value;
        const link = document.createElement("a");
        const filename = `${currentDataType}_qr_code.${downloadFormat}`;
        
        if (downloadFormat === 'svg') {
            // SVG Download (Requires an SVG output library, but since qrious is canvas-based,
            // we'll need to use a conversion/manual method or switch libraries.
            // For advanced demonstration, we'll inform the user for simplicity.)
            showMessage("SVG download is not supported by the current canvas library. PNG/JPEG only.", 'error');
            return;
        }

        const canvas = document.querySelector("#qrcode-canvas-container canvas");
        if (!canvas) return;

        let mimeType = `image/${downloadFormat}`;
        if (downloadFormat === 'jpeg') {
            // JPEG quality 0.9 (better than default)
            link.href = canvas.toDataURL(mimeType, 0.9);
        } else {
            // PNG download
            link.href = canvas.toDataURL(mimeType);
        }
        
        link.download = filename;
        link.click();
    }

    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
        changeDataType('TEXT'); // Initialize with default tab
        // Note: generateQR is called by changeDataType
    });
  </script>
</body>
</html>
